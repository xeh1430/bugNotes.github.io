<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="路漫漫其修远兮！"><title>Spring Boot 使用 Spring Security (二) | xeh的学习笔记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Boot 使用 Spring Security (二)</h1><a id="logo" href="/.">xeh的学习笔记</a><p class="description">将记录当成一种习惯</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Boot 使用 Spring Security (二)</h1><div class="post-meta">Jan 30, 2019<span> | </span><span class="category"><a href="/categories/spring-boot/">spring boot</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3.5k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 17</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库表设计"><span class="toc-number">2.</span> <span class="toc-text">数据库表设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-number">3.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引入-maven-依赖"><span class="toc-number">4.</span> <span class="toc-text">引入 maven 依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置数据库信息"><span class="toc-number">5.</span> <span class="toc-text">配置数据库信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建-pojo-dao-mapper-controller-文件"><span class="toc-number">6.</span> <span class="toc-text">创建 pojo/dao/mapper/controller 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#页面文件"><span class="toc-number">7.</span> <span class="toc-text">页面文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流程图"><span class="toc-number">8.</span> <span class="toc-text">流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringSecurity-登录认证流程图"><span class="toc-number">8.1.</span> <span class="toc-text">SpringSecurity 登录认证流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringSecurity-权限管理流程图"><span class="toc-number">8.2.</span> <span class="toc-text">SpringSecurity 权限管理流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加-SpringSecurity-实现登录及权限验证"><span class="toc-number">9.</span> <span class="toc-text">添加 SpringSecurity,实现登录及权限验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Spring-Security-的配置类-WebSecurityConfig"><span class="toc-number">9.1.</span> <span class="toc-text">创建 Spring Security 的配置类 WebSecurityConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-UserDetailsService（认证管理器）"><span class="toc-number">9.2.</span> <span class="toc-text">实现 UserDetailsService（认证管理器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-PasswordEncoder（加密类）"><span class="toc-number">9.3.</span> <span class="toc-text">实现 PasswordEncoder（加密类）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-AccessDeniedHandler-用户无权限处理器"><span class="toc-number">9.4.</span> <span class="toc-text">实现 AccessDeniedHandler (用户无权限处理器)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#继承-AbstractSecurityInterceptor（资源管理拦截器）"><span class="toc-number">9.5.</span> <span class="toc-text">继承 AbstractSecurityInterceptor（资源管理拦截器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-FilterInvocationSecurityMetadataSource-读取url资源"><span class="toc-number">9.6.</span> <span class="toc-text">实现 FilterInvocationSecurityMetadataSource (读取url资源)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-AccessDecisionManager-授权管理器"><span class="toc-number">9.7.</span> <span class="toc-text">实现 AccessDecisionManager (授权管理器)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">10.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#踩坑"><span class="toc-number">11.</span> <span class="toc-text">踩坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#加密方式"><span class="toc-number">11.1.</span> <span class="toc-text">加密方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#认证管理器异常抛出"><span class="toc-number">11.2.</span> <span class="toc-text">认证管理器异常抛出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#权限管理设置"><span class="toc-number">11.3.</span> <span class="toc-text">权限管理设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码"><span class="toc-number">11.4.</span> <span class="toc-text">源码</span></a></li></ol></li></ol></div></div><div class="post-content"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p><strong>使用 springboot+mybatis＋SpringSecurity 实现数据库动态的管理用户、角色、权限管理。</strong> </p>
<p><strong>细分角色和权限，并将用户、角色、权限和资源均采用数据库存储，并且自定义滤器，代替原有的FilterSecurityInterceptor过滤器，并分别实现 AccessDecisionManager、InvocationSecurityMetadataSourceService 和 serDetailsService，并在配置文件中进行相应配置。</strong></p>
</blockquote>
<h2 id="数据库表设计"><a href="#数据库表设计" class="headerlink" title="数据库表设计"></a>数据库表设计</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> <span class="keyword">comment</span><span class="string">'主键id'</span>,</span><br><span class="line">  username <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>  <span class="keyword">comment</span><span class="string">'用户名'</span>,</span><br><span class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'密码'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#角色表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">role</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> <span class="keyword">comment</span><span class="string">'主键id'</span>,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'角色名'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#用户角色表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_role</span><br><span class="line">(</span><br><span class="line">  user_id <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'用户id'</span>,</span><br><span class="line">  role_id <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'角色id'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#权限表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> permission (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment <span class="keyword">comment</span><span class="string">'主键id'</span>,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span> (<span class="number">200</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'角色名'</span>,</span><br><span class="line">  description <span class="built_in">varchar</span> (<span class="number">200</span>) <span class="keyword">default</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'描述'</span>,</span><br><span class="line">  <span class="keyword">url</span> <span class="built_in">varchar</span> (<span class="number">200</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'路径'</span>,</span><br><span class="line">  pid <span class="built_in">int</span> <span class="keyword">default</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'上级id'</span>,</span><br><span class="line">  primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#角色权限中间表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> permission_role (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment <span class="keyword">comment</span><span class="string">'主键id'</span>,</span><br><span class="line">  role_id <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'角色id'</span>,</span><br><span class="line">  permission_id <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">comment</span><span class="string">'权限id'</span>,</span><br><span class="line">  primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#插入用户</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span>(<span class="keyword">id</span>,username,<span class="keyword">password</span>)<span class="keyword">VALUES</span>(<span class="string">'1'</span>,<span class="keyword">admin</span><span class="string">','</span><span class="keyword">admin</span><span class="string">');</span></span><br><span class="line"><span class="string">INSERT INTO user(id,username,password)VALUES('</span><span class="number">2</span><span class="string">',user'</span>,<span class="string">'user'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span>(<span class="keyword">id</span>,username,<span class="keyword">password</span>)<span class="keyword">VALUES</span>(<span class="string">'3'</span>,<span class="keyword">test</span><span class="string">','</span><span class="keyword">test</span><span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#插入角色</span></span><br><span class="line"><span class="string">INSERT INTO role VALUES ('</span><span class="number">1</span><span class="string">', '</span>ROLE_ADMIN<span class="string">');  </span></span><br><span class="line"><span class="string">INSERT INTO role VALUES ('</span><span class="number">2</span><span class="string">', '</span>ROLE_USER<span class="string">'); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO user_role VALUES ('</span><span class="number">1</span><span class="string">', '</span><span class="number">1</span><span class="string">');  </span></span><br><span class="line"><span class="string">INSERT INTO user_role VALUES ('</span><span class="number">1</span><span class="string">', '</span><span class="number">2</span><span class="string">');  </span></span><br><span class="line"><span class="string">INSERT INTO user_role VALUES ('</span><span class="number">2</span><span class="string">', '</span><span class="number">2</span><span class="string">');  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO permission VALUES ('</span><span class="number">1</span><span class="string">', '</span>ROLE_USER<span class="string">', '</span><span class="keyword">user</span><span class="string">', '</span>/<span class="keyword">admin</span>/home<span class="string">', null);</span></span><br><span class="line"><span class="string">INSERT INTO permission_role VALUES ('</span><span class="number">1</span><span class="string">', '</span><span class="number">2</span><span class="string">', '</span><span class="number">1</span><span class="string">'));</span></span><br></pre></td></tr></table></figure>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="https://xeh1430.github.io/img/securityList.png" alt="项目结构"></p>
<h2 id="引入-maven-依赖"><a href="#引入-maven-依赖" class="headerlink" title="引入 maven 依赖"></a>引入 maven 依赖</h2><p>pom 文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql版本根据自身情况调整--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--thymeleaf页面展示控制--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="配置数据库信息"><a href="#配置数据库信息" class="headerlink" title="配置数据库信息"></a>配置数据库信息</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.url</span>=jdbc:mysql:<span class="comment">//localhost:3306/world</span></span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.username</span>=root</span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.password</span>=<span class="number">123456</span></span><br><span class="line">spring<span class="selector-class">.jpa</span><span class="selector-class">.database</span>=mysql</span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.driver-class-name</span>=com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.Driver</span></span><br><span class="line"></span><br><span class="line">server.port=<span class="number">8088</span></span><br><span class="line">        </span><br><span class="line">mybatis.mapper-locations=classpath:UserMapper.xml</span><br></pre></td></tr></table></figure>
<h2 id="创建-pojo-dao-mapper-controller-文件"><a href="#创建-pojo-dao-mapper-controller-文件" class="headerlink" title="创建 pojo/dao/mapper/controller 文件"></a>创建 pojo/dao/mapper/controller 文件</h2><p><strong><font color="red">PS: 功能比较简单，所以省略 service 文件，直接调用 dao 层文件；并将权限表的相关查询操作写在同一 mapper 文件</font></strong></p>
<p><strong>User.java</strong><br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> int id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> password;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Getter 和 Setter 自行补充 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Role.java</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Getter 和 Setter 自行补充 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Permission.java</strong><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Role &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="comment">//权限名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> name;</span><br><span class="line">    <span class="comment">//权限描述</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> descritpion;</span><br><span class="line">    <span class="comment">//授权链接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> url;</span><br><span class="line">    <span class="comment">//父节点id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Getter 和 Setter 自行补充 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> UserMapper.java </strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">//根据用户名查找用户所有权限信息</span></span><br><span class="line">    <span class="function">User <span class="title">findByUserName</span><span class="params">(String username)</span></span>;</span><br><span class="line">    <span class="comment">//获取所有权限信息</span></span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">findAllPermission</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">findByAdminUserId</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>UserMapper.xml</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="built_in">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;mapper namespace=<span class="string">"com.xeh.security.dao.UserMapper"</span>&gt;</span><br><span class="line">    &lt;resultMap <span class="built_in">id</span>=<span class="string">"userMap"</span> type=<span class="string">"com.xeh.security.model.User"</span>&gt;</span><br><span class="line">        &lt;<span class="built_in">id</span> <span class="keyword">property</span>=<span class="string">"id"</span> column=<span class="string">"ID"</span>/&gt;</span><br><span class="line">        &lt;<span class="literal">result</span> <span class="keyword">property</span>=<span class="string">"username"</span> column=<span class="string">"username"</span>/&gt;</span><br><span class="line">        &lt;<span class="literal">result</span> <span class="keyword">property</span>=<span class="string">"password"</span> column=<span class="string">"PASSWORD"</span>/&gt;</span><br><span class="line">        &lt;collection <span class="keyword">property</span>=<span class="string">"roles"</span> ofType=<span class="string">"com.xeh.security.model.Role"</span>&gt;</span><br><span class="line">            &lt;<span class="literal">result</span> column=<span class="string">"name"</span> <span class="keyword">property</span>=<span class="string">"name"</span>/&gt;</span><br><span class="line">        &lt;/collection&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">"findByUserName"</span> parameterType=<span class="string">"String"</span> resultMap=<span class="string">"userMap"</span>&gt;</span><br><span class="line">        select u.*</span><br><span class="line">        ,r.<span class="built_in">name</span></span><br><span class="line">        <span class="keyword">from</span> user u</span><br><span class="line">        LEFT JOIN user_role sru <span class="keyword">on</span> u.<span class="built_in">id</span> = sru.user_id</span><br><span class="line">        LEFT JOIN role r <span class="keyword">on</span> sru.role_id = r.<span class="built_in">id</span></span><br><span class="line">        <span class="keyword">where</span> username = <span class="comment">#&#123;username&#125;</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">"findAllPermission"</span> resultType=<span class="string">"com.xeh.security.model.Permission"</span>&gt;</span><br><span class="line">        select * <span class="keyword">from</span> permission</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">"findByAdminUserId"</span> parameterType=<span class="string">"int"</span> resultType=<span class="string">"com.xeh.security.model.Permission"</span>&gt;</span><br><span class="line">       select p.*</span><br><span class="line">        <span class="keyword">from</span> user u</span><br><span class="line">        left join user_role sru <span class="keyword">on</span> u.<span class="built_in">id</span> = sru.user_id</span><br><span class="line">        left join role r <span class="keyword">on</span> sru.role_id = r.<span class="built_in">id</span></span><br><span class="line">        left join permission_role spr <span class="keyword">on</span> spr.role_id = r.<span class="built_in">id</span></span><br><span class="line">        left join permission p <span class="keyword">on</span> p.<span class="built_in">id</span> = spr.permission_id</span><br><span class="line">        <span class="keyword">where</span> u.<span class="built_in">id</span> = <span class="comment">#&#123;userId&#125;</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>HelloController.java</strong><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(<span class="meta-string">"/admin/hello"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String index()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value =&#123;<span class="meta-string">""</span>,<span class="meta-string">"/"</span>,<span class="meta-string">"/home"</span>&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String home()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="meta-string">"/login"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String login()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="页面文件"><a href="#页面文件" class="headerlink" title="页面文件"></a>页面文件</h2><p><strong>home.html</strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span> </span></span></span><br><span class="line"><span class="xml">	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring Security Home<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>点击 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@</span></span></span><span class="template-tag">&#123;/<span class="name">admin</span>/hello&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span>这里<span class="tag">&lt;/<span class="name">a</span>&gt;</span>进入hello页面.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>hello.html</strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span></span><br><span class="line"><span class="xml">      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:inline</span>=<span class="string">"text"</span>&gt;</span>Hello [[$</span><span class="template-tag">&#123;#<span class="name">httpServletRequest.remoteUser</span>&#125;</span><span class="xml">]]!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">"isAuthenticated()"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 用户认证通过才能才显示 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>用户名:<span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>权限:<span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"principal.authorities"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">"hasRole('ADMIN')"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 用户角色为“ADMIN”才显示 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>【管理员】才能看见的内容<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">"hasRole('USER')"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 用户角色具有“USER”权限才显示 --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>【普通用户】才能看到的内容<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@</span></span></span><span class="template-tag">&#123;/<span class="name">logout</span>&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注销"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>login.html</strong><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;param.error&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    用户名或密码错误</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;param.logout&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    账户已退出登录</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@</span></span></span><span class="template-tag">&#123;/<span class="name">login</span>&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/login"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span> 用户名: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span> <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span> 密  码: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span> <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>这样，我们就搭好了连接数据库的 springboot 项目，接下来就是添加权限了</strong></p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><h3 id="SpringSecurity-登录认证流程图"><a href="#SpringSecurity-登录认证流程图" class="headerlink" title="SpringSecurity 登录认证流程图"></a>SpringSecurity 登录认证流程图</h3><p><img src="https://xeh1430.github.io/img/securityProcess.png" alt=""></p>
<h3 id="SpringSecurity-权限管理流程图"><a href="#SpringSecurity-权限管理流程图" class="headerlink" title="SpringSecurity 权限管理流程图"></a>SpringSecurity 权限管理流程图</h3><p><img src="https://xeh1430.github.io/img/securityPermission.png" alt=""></p>
<h2 id="添加-SpringSecurity-实现登录及权限验证"><a href="#添加-SpringSecurity-实现登录及权限验证" class="headerlink" title="添加 SpringSecurity,实现登录及权限验证"></a>添加 SpringSecurity,实现登录及权限验证</h2><h3 id="创建-Spring-Security-的配置类-WebSecurityConfig"><a href="#创建-Spring-Security-的配置类-WebSecurityConfig" class="headerlink" title="创建 Spring Security 的配置类 WebSecurityConfig"></a>创建 Spring Security 的配置类 WebSecurityConfig</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span></span><br><span class="line"><span class="variable">@EnableWebSecurity</span>  <span class="comment">//使得Spring Security提供并且支持了Spring MVC的集成</span></span><br><span class="line">public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户无权限拦截处理类</span></span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private MyAccessDeniedHandler accessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//授权管理</span></span><br><span class="line">	<span class="variable">@Autowired</span></span><br><span class="line">	private MyFilterSecurityInterceptor myFilterSecurityInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册UserDetailsService 的bean，通过用户名加载与该用户的用户名、密码以及权限相关的信息</span></span><br><span class="line">    <span class="variable">@Bean</span></span><br><span class="line">    UserDetailsService customUserService()&#123; <span class="comment">//注册UserDetailsService 的bean</span></span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">CustomUserDetailService</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*定义认证规则*/</span></span><br><span class="line">    @<span class="selector-tag">Override</span></span><br><span class="line">    <span class="selector-tag">protected</span> <span class="selector-tag">void</span> <span class="selector-tag">configure</span>(AuthenticationManagerBuilder auth) <span class="selector-tag">throws</span> <span class="selector-tag">Exception</span> &#123;</span><br><span class="line">        <span class="selector-tag">auth</span><span class="selector-class">.userDetailsService</span>(customUserService())<span class="selector-class">.passwordEncoder</span>(new MyPasswordEncoder()); <span class="comment">//user Details Service验证</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对URL进行权限配置</span></span><br><span class="line"><span class="comment">     * 该方法定义url的访问权限，登录路径，注销</span></span><br><span class="line"><span class="comment">     * @param http</span></span><br><span class="line"><span class="comment">     * @throws Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="selector-tag">Override</span></span><br><span class="line">    <span class="selector-tag">protected</span> <span class="selector-tag">void</span> <span class="selector-tag">configure</span>(HttpSecurity http) <span class="selector-tag">throws</span> <span class="selector-tag">Exception</span> &#123;</span><br><span class="line">        <span class="selector-tag">http</span></span><br><span class="line">            <span class="selector-class">.authorizeRequests</span>()</span><br><span class="line">            <span class="selector-class">.antMatchers</span>(<span class="string">"/"</span>, <span class="string">"/home"</span>)<span class="selector-class">.permitAll</span>()  <span class="comment">//任何人(包括没有经过验证的)都可以访问"/"和"/home"</span></span><br><span class="line">            <span class="comment">//.antMatchers("/admin/**").access("hasRole('USER')")</span></span><br><span class="line">            <span class="selector-class">.anyRequest</span>()<span class="selector-class">.authenticated</span>()  <span class="comment">//所有其他的URL都需要用户进行验证</span></span><br><span class="line">            <span class="selector-class">.and</span>()</span><br><span class="line">            <span class="comment">// 配置被拦截时的处理</span></span><br><span class="line">            <span class="selector-class">.exceptionHandling</span>()</span><br><span class="line">            <span class="comment">//添加无权限时的处理</span></span><br><span class="line">            <span class="selector-class">.accessDeniedHandler</span>(accessDeniedHandler)</span><br><span class="line">            <span class="selector-class">.and</span>()</span><br><span class="line">            <span class="selector-class">.formLogin</span>()  <span class="comment">//使用Java配置默认值设置了基于表单的验证。使用POST提交到"/login"时，需要用"username"和"password"进行验证</span></span><br><span class="line">            <span class="selector-class">.loginPage</span>(<span class="string">"/login"</span>)  <span class="comment">//指定在需要登录时将用户发送到的URL</span></span><br><span class="line">            <span class="selector-class">.permitAll</span>()  <span class="comment">//用户可以访问formLogin()相关的任何URL</span></span><br><span class="line">            <span class="selector-class">.and</span>()</span><br><span class="line">            <span class="selector-class">.logout</span>()  <span class="comment">//注销</span></span><br><span class="line">            <span class="selector-class">.permitAll</span>();  <span class="comment">//用户可以访问logout()相关的任何URL</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//权限控制 Filter</span></span><br><span class="line">        <span class="selector-tag">http</span><span class="selector-class">.addFilterBefore</span>(myFilterSecurityInterceptor, FilterSecurityInterceptor.class);	</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*忽略静态资源*/</span></span><br><span class="line">	<span class="comment">/*@Override</span></span><br><span class="line"><span class="comment">    public void configure(WebSecurity web) &#123;</span></span><br><span class="line"><span class="comment">        web.ignoring().antMatchers("/resources/static/**");</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-UserDetailsService（认证管理器）"><a href="#实现-UserDetailsService（认证管理器）" class="headerlink" title="实现 UserDetailsService（认证管理器）"></a>实现 UserDetailsService（认证管理器）</h3><p><strong><font color="red">自定义UserDetailsService 接口(认证管理器)，储存用户所有角色</font></strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper usersMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名加载与该用户的用户名、密码以及权限相关的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails loadUserByUsername(String username) <span class="keyword">throws</span> DisabledException &#123;</span><br><span class="line">        User user = usersMapper.findByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            List&lt;Permission&gt; permissions = usersMapper.findByAdminUserId(user.getId());</span><br><span class="line">            List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">new</span> ArrayList &lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Permission <span class="string">permission :</span> permissions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (permission != <span class="literal">null</span> &amp;&amp; permission.getName()!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    GrantedAuthority grantedAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(permission.getName());</span><br><span class="line">                    <span class="comment">//1：此处将权限信息添加到 GrantedAuthority 对象中，在后面进行全权限验证时会使用GrantedAuthority 对象。</span></span><br><span class="line">                    grantedAuthorities.add(grantedAuthority);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> org.springframework.security.core.userdetails.User(user.getUsername(), user.getPassword(), grantedAuthorities);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//throw new UsernameNotFoundException("用户名不存在");</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DisabledException(<span class="string">"----&gt;UserName :"</span> + username + <span class="string">" not found!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="实现-PasswordEncoder（加密类）"><a href="#实现-PasswordEncoder（加密类）" class="headerlink" title="实现 PasswordEncoder（加密类）"></a>实现 PasswordEncoder（加密类）</h3><p><strong><font color="red">spring security 版本在 5.0 后要添加 PasswordEncoder 验证</font></strong><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> charSequence.<span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(charSequence.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="实现-AccessDeniedHandler-用户无权限处理器"><a href="#实现-AccessDeniedHandler-用户无权限处理器" class="headerlink" title="实现 AccessDeniedHandler (用户无权限处理器)"></a>实现 AccessDeniedHandler (用户无权限处理器)</h3><p><strong><font color="red">用户无权限时处理类</font></strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Component</span></span><br><span class="line">public class MyAccessDeniedHandler implements AccessDeniedHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">//返回json形式的错误信息       </span></span><br><span class="line">        <span class="selector-tag">response</span><span class="selector-class">.setCharacterEncoding</span>(<span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="selector-tag">response</span><span class="selector-class">.setContentType</span>(<span class="string">"application/json"</span>);</span><br><span class="line">        <span class="selector-tag">response</span><span class="selector-class">.getWriter</span>()<span class="selector-class">.println</span>(<span class="string">"&#123;\"</span>code\<span class="string">":403,\"</span>message\<span class="string">":\"</span>你没有权限访问！\<span class="string">",\"</span>data\<span class="string">":\"</span>\<span class="string">"&#125;"</span>);</span><br><span class="line">        <span class="selector-tag">response</span><span class="selector-class">.getWriter</span>()<span class="selector-class">.flush</span>();</span><br><span class="line">        <span class="comment">/*//无权限时跳转</span></span><br><span class="line"><span class="comment">        response.sendRedirect("/home");</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="selector-tag">request</span><span class="selector-class">.getSession</span>()<span class="selector-class">.invalidate</span>();  <span class="comment">//会话结束</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="继承-AbstractSecurityInterceptor（资源管理拦截器）"><a href="#继承-AbstractSecurityInterceptor（资源管理拦截器）" class="headerlink" title="继承 AbstractSecurityInterceptor（资源管理拦截器）"></a>继承 AbstractSecurityInterceptor（资源管理拦截器）</h3><p><strong><font color="red">spring security 版本在 5.0 后要添加 PasswordEncoder 验证</font></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilterSecurityInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取被拦截url所需的权限</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FilterInvocationSecurityMetadataSource securityMetadataSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取权限管理器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMyAccessDecisionManager</span><span class="params">(MyAccessDecisionManager myAccessDecisionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setAccessDecisionManager(myAccessDecisionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">        invoke(fi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">//fi里面有一个被拦截的url</span></span><br><span class="line">        <span class="comment">//里面调用MyInvocationSecurityMetadataSource的getAttributes(Object object)这个方法获取fi对应的所有权限</span></span><br><span class="line">        <span class="comment">//再调用MyAccessDecisionManager的decide方法来校验用户的权限是否足够</span></span><br><span class="line">        InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//执行下一个拦截器</span></span><br><span class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getSecureObjectClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityMetadataSource <span class="title">obtainSecurityMetadataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.securityMetadataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="实现-FilterInvocationSecurityMetadataSource-读取url资源"><a href="#实现-FilterInvocationSecurityMetadataSource-读取url资源" class="headerlink" title="实现 FilterInvocationSecurityMetadataSource (读取url资源)"></a>实现 FilterInvocationSecurityMetadataSource (读取url资源)</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line"><span class="keyword">public</span> class MySecurityMetadataSource implements</span><br><span class="line">        FilterInvocationSecurityMetadataSource &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    <span class="keyword">private</span> UserMapper usersMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源权限集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, Collection&lt;ConfigAttribute&gt;&gt; <span class="built_in">map</span> =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取权限表中所有权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> loadResourceDefine()&#123;</span><br><span class="line">        <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;();</span><br><span class="line">        Collection&lt;ConfigAttribute&gt; array;</span><br><span class="line">        ConfigAttribute cfg;</span><br><span class="line">        List&lt;Permission&gt; permissions = usersMapper.findAllPermission();</span><br><span class="line">        <span class="keyword">for</span>(Permission permission : permissions) &#123;</span><br><span class="line">            array = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            cfg = <span class="keyword">new</span> SecurityConfig(permission.getName());</span><br><span class="line">            <span class="comment">//此处只添加了用户的名字，其实还可以添加更多权限的信息，例如请求方法到ConfigAttribute的集合中去。此处添加的信息将会作为MyAccessDecisionManager类的decide的第三个参数。</span></span><br><span class="line">            array.<span class="built_in">add</span>(cfg);</span><br><span class="line">            <span class="comment">//用权限的getUrl() 作为map的key，用ConfigAttribute的集合作为 value，</span></span><br><span class="line">            <span class="built_in">map</span>.put(permission.getUrl(), array);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此方法是为了判定用户请求的url 是否在权限表中，如果在权限表中，则返回给 decide 方法，用来判定用户是否有此权限。如果不在权限表中则放行。</span></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; getAttributes(<span class="keyword">Object</span> object) <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">map</span> ==<span class="keyword">null</span>) loadResourceDefine();</span><br><span class="line">        <span class="comment">//object 中包含用户请求的 url 信息</span></span><br><span class="line">        <span class="keyword">String</span> url = ((FilterInvocation) object).getRequestUrl();</span><br><span class="line">        <span class="keyword">String</span> resUrl;</span><br><span class="line">        <span class="keyword">for</span>(Iterator&lt;<span class="keyword">String</span>&gt; iter = <span class="built_in">map</span>.keySet().iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">            resUrl = iter.next();</span><br><span class="line">            <span class="keyword">if</span>(resUrl .matches(url)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">map</span>.<span class="built_in">get</span>(resUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> supports(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-AccessDecisionManager-授权管理器"><a href="#实现-AccessDecisionManager-授权管理器" class="headerlink" title="实现 AccessDecisionManager (授权管理器)"></a>实现 AccessDecisionManager (授权管理器)</h3><p><strong><font color="red">判断用户请求的资源是否能通过</font></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAccessDecisionManager</span> <span class="keyword">implements</span> <span class="title">AccessDecisionManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// decide 方法是判定是否拥有权限的决策方法，</span></span><br><span class="line">    <span class="comment">//authentication 是CustomUserService中循环添加到 GrantedAuthority 对象中的权限信息集合.</span></span><br><span class="line">    <span class="comment">//object 包含客户端发起的请求的requset信息，可转换为 HttpServletRequest request = ((FilterInvocation) object).getHttpRequest();</span></span><br><span class="line">    <span class="comment">//configAttributes 为MyInvocationSecurityMetadataSource的getAttributes(Object object)这个方法返回的结果，此方法是为了判定用户请求的url 是否在权限表中，如果在权限表中，则返回给 decide 方法，用来判定用户是否有此权限。如果不在权限表中则放行。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>== configAttributes || configAttributes.size() &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ConfigAttribute c;</span><br><span class="line">        String needRole;</span><br><span class="line">        <span class="keyword">for</span>(Iterator&lt;ConfigAttribute&gt; iter = configAttributes.iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">            c = iter.next();</span><br><span class="line">            needRole = c.getAttribute();</span><br><span class="line">            <span class="comment">//authentication 为 CustomUserDetailService 中循环添加到 GrantedAuthority 对象中的权限信息集合</span></span><br><span class="line">            <span class="keyword">for</span>(GrantedAuthority ga : authentication.getAuthorities()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(needRole.trim().equals(ga.getAuthority())) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(<span class="string">"no right"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="https://xeh1430.github.io/img/securityHome.png" alt="首页"><br><img src="https://xeh1430.github.io/img/securityLogin.png" alt="登录页面"><br><img src="https://xeh1430.github.io/img/securityAdminHello.png" alt="管理员权限的 hello 页面"><br><img src="https://xeh1430.github.io/img/securityUserHello.png" alt="普通用户权限的 hello 页面"><br><img src="https://xeh1430.github.io/img/securityNoPermission.png" alt="无权限用户登录后页面"></p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a><font color="red">踩坑</font></h2><h3 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h3><p><strong>WebSecurityConfig 配置文件认证规则方法”configure(AuthenticationManagerBuilder auth)” 报错</strong><br><strong><code>java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id &quot;null&quot;</code></strong></p>
<p><strong><font color="red">原因: spring security 版本在5.0后，之前版本中的 NoOpPasswordEncoder 被 DelegatingPasswordEncoder 取代了，而你保存在数据库中的密码没有指定加密方式,就要加个 PasswordEncoder 验证</font></strong><br><img src="https://xeh1430.github.io/img/securitykeng1.png" alt=""></p>
<h3 id="认证管理器异常抛出"><a href="#认证管理器异常抛出" class="headerlink" title="认证管理器异常抛出"></a>认证管理器异常抛出</h3><p><strong>CustomUserDetailService 类 loadUserByUsername 默认抛出 UsernameNotFoundException，用 DisabledException 替换 UsernameNotFoundException</strong><br><img src="https://xeh1430.github.io/img/securitykeng2.png" alt=""><br><strong><font color="red">这里我们不抛出 UsernameNotFoundException 因为 Security 会把我们抛出的该异常捕捉并换掉，导致抛出的异常无法被 ControllerAdvice 捕捉到，无法进行统一异常处理；所以我们只需要打印正确的异常消息即可，Security 自动把异常添加到 HttpServletRequest 或 HttpSession 中</font></strong></p>
<h3 id="权限管理设置"><a href="#权限管理设置" class="headerlink" title="权限管理设置"></a>权限管理设置</h3><p><strong>1.使用权限表设置，如上</strong><br><strong>即<a href="#SpringSecurity-权限管理流程图">权限管理流程图</a>所示，通过实现 MyFilterSecurityInterceptor(资源管理拦截器)、MyAccessDecisionManager(授权管理器)和MySecurityMetadataSource(拦截器)进行权限拦截。</strong>  </p>
<p><strong>2.不通过权限表设置<br>2.1 使用注解方式在 controller 和 WebSecurityConfig 上进行设置</strong><br><img src="https://xeh1430.github.io/img/PreAuthorize.png" alt=""><br><strong>2.2 直接在 WebSecurityConfig 中 configure(HttpSecurity http) 方法进行设置</strong><br><img src="https://xeh1430.github.io/img/securityAccess.png" alt=""></p>
<p><strong><font color="red">PS:hasRole() 方法默认含有 ‘ROLE_’ 前缀，书写方式：‘ROLE_ADMIN’ –&gt; hasRole(‘ADMIN’) </font></strong></p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><strong>项目 github 源码：<a href="https://github.com/xeh1430/xehProject/tree/master/security" target="_blank" rel="noopener">https://github.com/xeh1430/xehProject/tree/master/security</a></strong></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/text/knowledgeCurse.html">知识的诅咒</a><a class="next" href="/text/springSecurity1.html">Spring Boot 使用 Spring Security (一)</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'beb8cdcc473672dd54e5',
  clientSecret: '6fb75946c9614f3b21462fb9115bdcc7c9e08072',
  repo: 'xeh1430.github.io',
  owner: 'xeh1430',
  admin: ['xeh1430'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web-Service/">Web Service</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring-boot/">spring boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读/">阅读</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/text/firstAid.html">生活急救常识</a></li><li class="post-list-item"><a class="post-list-link" href="/text/dataStructure2.html">数据结构与算法(二)——数组、链表</a></li><li class="post-list-item"><a class="post-list-link" href="/text/dataStructure1.html">数据结构与算法(一)——复杂度分析</a></li><li class="post-list-item"><a class="post-list-link" href="/text/knowledgeCurse.html">知识的诅咒</a></li><li class="post-list-item"><a class="post-list-link" href="/text/springSecurity2.html">Spring Boot 使用 Spring Security (二)</a></li><li class="post-list-item"><a class="post-list-link" href="/text/springSecurity1.html">Spring Boot 使用 Spring Security (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/text/springBoot.html">Spring Boot 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/text/webService2.html">Web Service 调用天气预报</a></li><li class="post-list-item"><a class="post-list-link" href="/text/webService1.html">Web Service 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/text/axure.html">Axure 入门使用</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://news.cnblogs.com/" title="博客园新闻" target="_blank">博客园新闻</a><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的网络日志" target="_blank">阮一峰的网络日志</a><ul></ul><a href="https://gitee.com/explore" title="码云 开源软件" target="_blank">码云 开源软件</a><ul></ul><a href="https://github.com/" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">xeh的学习笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>